<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì´ëª¨ì§€ ì°¾ê¸° â€” ëª¨ë°”ì¼ ë‹¨ê³„ì§„í–‰ / ì¹´ìš´íŠ¸ë‹¤ìš´ / ëœë¤ ë°©í•´ ì´ëª¨ì§€</title>
  <style>
    :root { --gap: 8px; --size: 60px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif; margin: 0; padding: 56px 16px 128px; text-align: center; }
    h1 { margin: 0 0 6px; font-size: 1.6rem; }
    p.lead { margin: 0 0 18px; color: #444; }
    .toolbar { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 12px; }
    button { border: 1px solid #ccc; border-radius: 12px; padding: 10px 14px; background: #fff; cursor: pointer; font-weight: 600; }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    .stage { margin: 18px auto; max-width: 900px; }
    .stage h2 { margin: 8px 0; }
    .grid { display: inline-grid; gap: var(--gap); margin-top: 8px; }
    .cell { width: var(--size); height: var(--size); display: flex; align-items: center; justify-content: center; text-align: center; padding: 0; font-size: 38px; line-height: 1; border: 1px solid #ddd; border-radius: 14px; user-select: none; transition: transform .06s; touch-action: manipulation; }
    .cell:active { transform: scale(.98); }
    .note { font-size: .9rem; color: #666; margin-top: 6px; }
    .status { margin-top: 14px; font-size: .95rem; color: #333; min-height: 24px; }
    .ok { color: #087443; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }
    footer { position: fixed; left: 0; right: 0; bottom: 0; background: #fafafa; border-top: 1px solid #eee; padding: 10px 16px; }
    .log { max-width: 980px; margin: 0 auto; text-align: left; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; white-space: pre-wrap; word-break: break-word; }

    /* ì˜¤ë¥¸ìª½ ìƒë‹¨ HUD íƒ€ì´ë¨¸ â€” 20% í™•ëŒ€ */
    #hud { position: fixed; top: 8px; right: 8px; z-index: 10; background: rgba(255,255,255,.85); backdrop-filter: blur(6px); border: 1px solid #eee; border-radius: 12px; padding: 6px 10px; display: flex; align-items: center; gap: 10px; }
    #timer { font-weight: 800; font-variant-numeric: tabular-nums; letter-spacing: .4px; font-size: 1.2em; }

    /* ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ */
    #countdown { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); color: #fff; z-index: 20; }
    #countdown span { font-size: 72px; font-weight: 900; text-shadow: 0 2px 12px rgba(0,0,0,.4); }

    /* ì˜¤ë‹µ ì‹œ í”ë“¤ë¦¼ íš¨ê³¼ */
    @keyframes shake { 0%{transform: translateX(0);} 25%{transform: translateX(-5px);} 50%{transform: translateX(5px);} 75%{transform: translateX(-3px);} 100%{transform: translateX(0);} }
    .shake { animation: shake .28s ease both; }

    @media (max-width: 400px){ :root{ --size: 56px; } #countdown span{ font-size: 56px; } }
  </style>
</head>
<body>
  <h1>ì›ƒëŠ” ì´ëª¨ì§€ í•œ ì¹¸ë§Œ ì°¾ê¸° ğŸ˜Š</h1>
  <p class="lead">ê·œì¹™: ê° ìŠ¤í…Œì´ì§€ ê·¸ë¦¬ë“œì—ì„œ <strong>ë‹¨ 1ì¹¸ì˜ ğŸ˜Š</strong>ë¥¼ ì°¾ìœ¼ì„¸ìš”. ë‚˜ë¨¸ì§€ëŠ” <strong>ë…¸ë€ í™”ë‚¨(ğŸ˜ )ê³¼ ë¬´í‘œì •(ğŸ˜)</strong>ì´ ë¬´ì‘ìœ„ ë¹„ìœ¨ë¡œ ì„ì—¬ ìˆìŠµë‹ˆë‹¤.</p>

  <div id="hud" aria-live="polite" aria-label="ì§„í–‰ HUD">
    <span>ê²½ê³¼</span>
    <span id="timer">00:00.0</span>
  </div>

  <div id="countdown"><span>3</span></div>

  <div class="toolbar">
    <button id="btn-start">ì‹œì‘</button>
    <button id="btn-restart" disabled>ìƒˆë¡œ ì‹œì‘(ì„ê¸°)</button>
    <button id="btn-share" disabled>ê²°ê³¼ ê³µìœ </button>
    <button id="btn-copy" disabled>ê²°ê³¼ ë§í¬ ë³µì‚¬</button>
  </div>

  <section id="stages"></section>

  <div class="status" id="status">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

  <footer>
    <div class="log" id="log" aria-live="polite"></div>
  </footer>

  <script>
    // ===== ì„¤ì • =====
    const STAGES = [
      { n: 3, label: '1ë‹¨ê³„ (3Ã—3)' },
      { n: 4, label: '2ë‹¨ê³„ (4Ã—4)' },
      { n: 5, label: '3ë‹¨ê³„ (5Ã—5)' },
      { n: 6, label: '4ë‹¨ê³„ (6Ã—6)' },
      { n: 7, label: '5ë‹¨ê³„ (7Ã—7)' },
    ];

    const EMOJI_ANGRY = 'ğŸ˜ '; // ë…¸ë€ìƒ‰ í™”ë‚¨
    const EMOJI_NEUTRAL = 'ğŸ˜';
    const EMOJI_SMILE = 'ğŸ™‚'; // ë¹¨ê°„/ë¶„í™ ë³¼í„°ì¹˜ ì—†ëŠ” ë¯¸ì†Œ

    // ===== ì‹œë“œ ë‚œìˆ˜ (ì¬í˜„ì„± + ê³µìœ  ë§í¬) =====
    function mulberry32(a){
      return function(){
        let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296;
      }
    }
    function strToSeed(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }

    const url = new URL(location.href);
    let seedParam = url.searchParams.get('seed');
    if(!seedParam){
      const rand = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*2**32);
      seedParam = rand.toString(36);
      const u = new URL(location.href); u.searchParams.set('seed', seedParam); history.replaceState(null, '', u);
    }
    const SEED = strToSeed(seedParam);
    const rng = mulberry32(SEED);

    function pickAnswerIndex(size){ const total = size*size; return Math.floor(rng()*total); }
    const answers = STAGES.map(s=>pickAnswerIndex(s.n));

    // ê° ìŠ¤í…Œì´ì§€ë³„ ë°©í•´ ì´ëª¨ì§€ ë¹„ìœ¨(ğŸ˜  ë¹„ì¤‘) â€” 0.4 ~ 0.8 ë²”ìœ„ ëœë¤
    const distractorRatios = STAGES.map(()=> 0.4 + 0.4 * rng());

    // ===== DOM ì—˜ë¦¬ë¨¼íŠ¸ =====
    const stagesEl = document.getElementById('stages');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const btnStart = document.getElementById('btn-start');
    const btnRestart = document.getElementById('btn-restart');
    const btnShare = document.getElementById('btn-share');
    const btnCopy = document.getElementById('btn-copy');
    const timerEl = document.getElementById('timer');
    const countdownEl = document.getElementById('countdown');
    const countdownNumEl = countdownEl.querySelector('span');

    // ê¸°ë¡ êµ¬ì¡°
    let runStart = null; // ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥¸ ìˆœê°„ìœ¼ë¡œ ì„¤ì •
    const records = []; // {stage, grid, clickedAt, clickedAtIso, durationMs}
    let currentStage = 0; // 0ë¶€í„° ìˆœì°¨ ì§„í–‰

    // ===== íƒ€ì´ë¨¸ =====
    let timerId = null;
    function fmtTimeMMSS(ms){
      const total = Math.max(0, ms|0);
      const m = Math.floor(total/60000);
      const s = Math.floor((total%60000)/1000);
      const d = Math.floor((total%1000)/100); // 0.1ì´ˆ ë‹¨ìœ„
      const pad = n=>String(n).padStart(2,'0');
      return `${pad(m)}:${pad(s)}.${d}`;
    }
    function startTimer(){
      if(timerId) clearInterval(timerId);
      runStart = Date.now();
      timerId = setInterval(()=>{ timerEl.textContent = fmtTimeMMSS(Date.now() - runStart); }, 100);
    }
    function stopTimer(){ if(timerId) clearInterval(timerId); }

    function fmtLocalWithMs(ts){ const d = new Date(ts); const pad = n=>String(n).padStart(2,'0'); const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate()); const h=pad(d.getHours()), mi=pad(d.getMinutes()), s=pad(d.getSeconds()); const ms=String(d.getMilliseconds()).padStart(3,'0'); return `${y}-${m}-${da} ${h}:${mi}:${s}.${ms}`; }

    function writeLog(){
      if(runStart===null){ logEl.textContent = ''; return; }
      const head = `ì‹œë“œ: ${seedParam}\nì‹œì‘: ${fmtLocalWithMs(runStart)} (ISO: ${new Date(runStart).toISOString()})`;
      const lines = records.map(r=>`- ${r.stage} â€” í´ë¦­: ${fmtLocalWithMs(r.clickedAt)} (ISO: ${r.clickedAtIso}), ì†Œìš”: ${r.durationMs}ms, ê·¸ë¦¬ë“œ ${r.grid}ì¹¸`);
      let tail = '';
      if(records.length === STAGES.length){ const end = records[records.length-1].clickedAt; tail = `\nì™„ë£Œ: ${fmtLocalWithMs(end)} (ISO: ${new Date(end).toISOString()})\nì´ ì†Œìš”: ${end - runStart}ms`; }
      logEl.textContent = [head, ...lines, tail].filter(Boolean).join('\n');
    }

    // ===== ìŠ¤í…Œì´ì§€ ë Œë” (ë²„ê·¸ ë°©ì§€: ì›ìì  êµì²´ + ì¬ì§„ì… ê°€ë“œ) =====
    function renderStage(idx){
      if(idx < 0 || idx >= STAGES.length) return;
      if(renderStage._busy) return; // ì¬ì§„ì… ë°©ì§€
      renderStage._busy = true;
      try {
        const {n, label} = STAGES[idx];
        const total = n*n; const answer = answers[idx];
        const ratioAngry = distractorRatios[idx];

        // DOM êµ¬ì„± (ê°€ìƒ ì»¨í…Œì´ë„ˆì— ë¨¼ì € êµ¬ì„±í•œ ë’¤ êµì²´)
        const stageWrap = document.createElement('div'); stageWrap.className = 'stage'; stageWrap.dataset.index = idx;
        const h2 = document.createElement('h2'); h2.textContent = label;
        const grid = document.createElement('div'); grid.className = 'grid'; grid.style.gridTemplateColumns = `repeat(${n}, 1fr)`;

        for(let i=0;i<total;i++){
          const cell = document.createElement('button');
          cell.type = 'button'; cell.className = 'cell';
          cell.setAttribute('aria-label', i===answer ? 'ì •ë‹µ' : 'ì˜¤ë‹µ');
          if(i===answer){
            cell.textContent = EMOJI_SMILE;
          } else {
            // ë¹„ì •ë‹µ: ë¹„ìœ¨ì— ë”°ë¼ ğŸ˜ /ğŸ˜ ì„ê¸° (ì‹œë“œ ê¸°ë°˜)
            cell.textContent = (rng() < ratioAngry) ? EMOJI_ANGRY : EMOJI_NEUTRAL;
          }
          cell.addEventListener('click', ()=>{
            if(i!==answer){
              // ì˜¤ë‹µ: ì ê¹ í”ë“¤ë¦¼
              cell.classList.add('shake'); cell.disabled = true;
              setTimeout(()=>{ cell.classList.remove('shake'); cell.disabled = false; }, 300);
              statusEl.innerHTML = `<span class="err">ì˜¤ë‹µ! ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</span>`;
              return;
            }
            // ì •ë‹µ ì²˜ë¦¬
            const now = Date.now();
            const rec = { stage: label, grid: `${n}Ã—${n}`, clickedAt: now, clickedAtIso: new Date(now).toISOString(), durationMs: now - (records.length ? records[records.length-1].clickedAt : runStart) };
            records.push(rec); writeLog();
            statusEl.innerHTML = `<span class=\"ok\">í†µê³¼!</span> ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.`;
            [...grid.children].forEach(c=>c.disabled = true);

            currentStage++;
            if(currentStage < STAGES.length){
              spawnStage(currentStage);
            } else {
              statusEl.innerHTML = `<span class=\"ok\">ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.</span>`;
              btnShare.disabled = false; btnCopy.disabled = false; stopTimer();
              logEl.parentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
          grid.appendChild(cell);
        }

        const note = document.createElement('div'); note.className = 'note';
        note.textContent = `ì´ ${total}ì¹¸: ${EMOJI_SMILE} 1ê°œ, ë‚˜ë¨¸ì§€ ${total-1}ì¹¸ì€ ${EMOJI_ANGRY}/${EMOJI_NEUTRAL} ëœë¤`;

        stageWrap.appendChild(h2); stageWrap.appendChild(grid); stageWrap.appendChild(note);

        // ê¸°ì¡´ ì»¨í…ì¸ ë¥¼ ì›ìì ìœ¼ë¡œ êµì²´ â†’ ë Œë” ì¤‘ê°„ì— ë¹ˆ í™”ë©´ ë°©ì§€
        stagesEl.replaceChildren(stageWrap);
        stageWrap.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // ì§„í–‰ í‘œì‹œ ë° ë’¤ë¡œê°€ê¸° ë³´í˜¸: ë’¤ë¡œê°€ë©´ ì™„ì „ ë¦¬ì…‹
        history.pushState({emoji:'v1', stage: idx}, '');
      } finally {
        renderStage._busy = false;
      }
    }

    function spawnStage(idx){ renderStage(idx); }

    // ===== ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ ì‹œì‘ =====
    function runCountdownThenStart(){
      let n = 3;
      countdownNumEl.textContent = String(n);
      countdownEl.style.display = 'flex';
      btnStart.disabled = true; btnRestart.disabled = true; btnShare.disabled = true; btnCopy.disabled = true;
      const iv = setInterval(()=>{
        n--;
        if(n>0){ countdownNumEl.textContent = String(n); }
        else if(n===0){ countdownNumEl.textContent = 'ì‹œì‘!'; }
        else {
          clearInterval(iv);
          countdownEl.style.display = 'none';
          // íˆìŠ¤í† ë¦¬ ê°€ë“œ ì„¸íŒ…(ë’¤ë¡œê°€ê¸°=ì™„ì „ ë¦¬ì…‹)
          history.replaceState({emoji:'v1', stage: 'init'}, '');
          history.pushState({emoji:'v1', guard:true}, '');
          window.addEventListener('popstate', ()=>{
            const rand = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*2**32);
            const newSeed = rand.toString(36);
            const u = new URL(location.href); u.searchParams.set('seed', newSeed); location.replace(u);
          }, { once: true });

          statusEl.textContent = '';
          startTimer(); writeLog(); spawnStage(0);
          btnRestart.disabled = false; // ì‹œì‘ í›„ ì¬ì‹œì‘ ê°€ëŠ¥

          // ===== ì½˜ì†” ì§„ë‹¨ í…ŒìŠ¤íŠ¸ (UI ì—†ìŒ) =====
          setTimeout(runSelfTests, 350);
        }
      }, 1000);
    }

    // ===== ì‹œì‘/ì¬ì‹œì‘/ê³µìœ  =====
    btnStart.addEventListener('click', ()=>{
      if(runStart!==null) return; // ì´ë¯¸ ì‹œì‘ë¨
      runCountdownThenStart();
    });

    btnRestart.addEventListener('click', ()=>{
      const rand = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*2**32);
      const newSeed = rand.toString(36);
      const u = new URL(location.href); u.searchParams.set('seed', newSeed); location.href = u.toString();
    });

    async function makeShareText(){ const title = 'ì´ëª¨ì§€ ì°¾ê¸° ê²°ê³¼'; const text = logEl.textContent.trim(); const shareUrl = new URL(location.href); return { title, text, url: shareUrl.toString() }; }

    btnShare.addEventListener('click', async ()=>{
      const payload = await makeShareText();
      if(navigator.share){ try { await navigator.share(payload); } catch(e){ alert('ê³µìœ ê°€ ì·¨ì†Œë˜ì—ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } }
      else { alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì‹œìŠ¤í…œ ê³µìœ ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. "ê²°ê³¼ ë§í¬ ë³µì‚¬"ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.'); }
    });

    btnCopy.addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(location.href); btnCopy.textContent = 'ë³µì‚¬ë¨!'; setTimeout(()=>btnCopy.textContent='ê²°ê³¼ ë§í¬ ë³µì‚¬', 1400); }
      catch(e){ prompt('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì œí•œë˜ì–´ ìˆ˜ë™ ë³µì‚¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì•„ë˜ ë§í¬ ì „ì²´ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', location.href); }
    });

    // ===== ì½˜ì†”ìš© ê°„ë‹¨ í…ŒìŠ¤íŠ¸ (UI X) =====
    function runSelfTests(){
      try {
        console.assert(Array.isArray(STAGES) && STAGES.length === 5, 'STAGES ê¸¸ì´=5');
        const stage = document.querySelector('.stage');
        console.assert(!!stage, 'í˜„ì¬ ìŠ¤í…Œì´ì§€ 1ê°œ í‘œì‹œ');
        const grid = document.querySelector('.grid');
        const n = STAGES[currentStage]?.n || 3;
        console.assert(grid && grid.children.length === n*n, 'ê·¸ë¦¬ë“œ ì¹¸ ìˆ˜ n*n');
        const cells = [...grid.children];
        const smiles = cells.filter(c=>c.textContent===EMOJI_SMILE).length;
        const others = cells.filter(c=>c.textContent!==EMOJI_SMILE);
        console.assert(smiles === 1, 'ğŸ™‚ 1ê°œ');
        console.assert(others.every(c=>c.textContent===EMOJI_ANGRY || c.textContent===EMOJI_NEUTRAL), 'ë‚˜ë¨¸ì§€ ğŸ˜ /ğŸ˜');
        const t0 = document.getElementById('timer').textContent;
        setTimeout(()=>{ const t1 = document.getElementById('timer').textContent; console.assert(t0 !== t1, 'íƒ€ì´ë¨¸ ì¦ê°€'); }, 300);
      } catch(e){ console.warn('SelfTests ì‹¤íŒ¨:', e); }
    }
  </script>
</body>
</html>

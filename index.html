<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ìˆ¨ì€ ë¯¸ì†Œê°€ ë‚˜ë¥¼ ë³´ê³  ìˆë‹¤ ğŸ™‚ â€” ê³µí¬ í…Œë§ˆ ì—ë””ì…˜</title>
  <meta name="description" content="í•œ ì¹¸ì˜ ë¯¸ì†Œë¥¼ ì°¾ì•„ë¼. ì›ƒì§€ ì•Šìœ¼ë©´â€¦ ë‹¤ë¥¸ í‘œì •ë“¤ì´ ë”°ë¼ì˜¨ë‹¤." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Serif+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --gap: 8px;
      --size: 60px;
      --bg: #060709;
      --fg: #e9eef5;
      --muted: #95a3b0;
      --accent: #ff2f55;
      --accent-2: #c0142e;
      --card: rgba(10, 12, 16, .7);
      --ring: rgba(255,49,88,.35);
      --radius: 16px;
      --shadow: 0 22px 40px rgba(0,0,0,.55);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      padding: 56px 16px 24px;
      text-align: center;
      background:
        radial-gradient(1200px 800px at 50% 24%, rgba(255,47,85,.04), transparent 60%),
        #060709;
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .grain{ pointer-events:none; position:fixed; inset:0; opacity:.07; background-image:url('data:image/svg+xml;utf8,\
    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"160\" height=\"160\" viewBox=\"0 0 40 40\">\
      <filter id=\"n\"><feTurbulence type=\"fractalNoise\" baseFrequency=\"0.9\" numOctaves=\"2\" stitchTiles=\"stitch\"/></filter>\
      <rect width=\"100%\" height=\"100%\" filter=\"url(%23n)\" opacity=\"0.9\"/>\
    </svg>'); mix-blend-mode:overlay; animation: grain 12s steps(12) infinite; z-index: 1; }
    .scan{ pointer-events:none; position:fixed; inset:0; background: repeating-linear-gradient(0deg, rgba(255,255,255,.06) 0 1px, transparent 1px 3px); opacity:.05; z-index:0 }
    @keyframes grain{ 0%{transform:translate(0,0)} 100%{transform:translate(-40px,-40px)} }
    .fog, .fog::after, .fog::before{ position:fixed; inset:-20% -40%; pointer-events:none; }
    .fog{ z-index:0; background: radial-gradient(40% 25% at 10% 30%, rgba(255,255,255,.03), transparent 60%), radial-gradient(35% 25% at 80% 70%, rgba(255,255,255,.025), transparent 60%); filter: blur(12px); animation: fog-move 120s linear infinite; }
    .fog::after{ content:\"\"; background: radial-gradient(30% 20% at 70% 40%, rgba(255,255,255,.025), transparent 60%); filter: blur(18px); animation: fog-move 100s linear reverse infinite; }
    .fog::before{ content:\"\"; background: radial-gradient(35% 22% at 30% 80%, rgba(255,255,255,.02), transparent 60%); filter: blur(16px); animation: fog-move 140s linear infinite; }
    @keyframes fog-move{ to{ transform: translate3d(-4%, -2%, 0) scale(1.06) } }
    .flicker{ position:fixed; inset:0; background: radial-gradient(circle at 50% 60%, rgba(255,47,85,.08), transparent 40%), rgba(0,0,0,.82); mix-blend-mode: multiply; opacity:0; pointer-events:none; z-index:5; transition: opacity .18s ease; }
    h1 {
      margin: 0 0 6px;
      font-size: clamp(22px, 5.4vw, 40px);
      font-family: 'Black Han Sans', 'Noto Serif KR', serif;
      letter-spacing: .3px;
      display: inline-block;
      position: relative;
      filter: drop-shadow(0 8px 22px rgba(0,0,0,.6));
      animation: throb 4s ease-in-out infinite;
    }
    h1::before, h1::after {
      content: attr(data-glitch);
      position: absolute; inset: 0; pointer-events: none; mix-blend-mode: screen;
    }
    h1::before { color: #ff0037; transform: translate3d(-1px,0,0); clip-path: polygon(0 0, 100% 0, 100% 48%, 0 52%); animation: glitchTop 2.6s infinite linear; }
    h1::after { color: #00ddff; transform: translate3d(1px,0,0); clip-path: polygon(0 52%, 100% 48%, 100% 100%, 0 100%); animation: glitchBottom 3.1s infinite linear; }
    @keyframes glitchTop{ 10%{transform:translateX(-2px)} 20%{transform:translateX(0)} 30%{transform:translateX(-1px)} 40%{transform:translateX(-3px)} 50%{transform:translateX(0)} }
    @keyframes glitchBottom{ 8%{transform:translateX(2px)} 18%{transform:translateX(0)} 38%{transform:translateX(3px)} 58%{transform:translateX(0)} 78%{transform:translateX(1px)} }
    @keyframes throb{ 0%,100%{ text-shadow:0 0 0 rgba(255,47,85,.0)} 50%{ text-shadow:0 0 18px rgba(255,47,85,.28) } }
    p.lead { margin: 0 0 18px; color: var(--muted); font-family: 'Noto Serif KR', serif; }
    .toolbar { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 12px; }
    button {
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      padding: 10px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      color: var(--fg);
      cursor: pointer;
      font-weight: 800;
      box-shadow: var(--shadow);
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
    }
    button:hover { transform: translateY(-2px); }
    button[disabled] { opacity: .45; cursor: not-allowed; }
    .stage { margin: 18px auto; max-width: 900px; }
    .stage h2 { margin: 8px 0; font-family: 'Noto Serif KR', serif; }
    .grid { display: inline-grid; gap: var(--gap); margin-top: 8px; width: 100%; }
    .cell {
      width: var(--size); height: var(--size);
      display: flex; align-items: center; justify-content: center;
      text-align: center; padding: 0;
      font-size: calc(var(--size) * 0.66); line-height: 1;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px; user-select: none; transition: transform .06s, box-shadow .18s ease;
      touch-action: manipulation; background: var(--card);
      box-shadow: 0 0 0 0 var(--ring), var(--shadow);
    }
    .cell:active { transform: scale(.98); }
    .cell:focus-visible { box-shadow: 0 0 0 10px var(--ring), var(--shadow); outline: none; }
    .note { font-size: .9rem; color: var(--muted); margin-top: 6px; }
    .status { margin-top: 14px; font-size: .95rem; color: #dde7f0; min-height: 24px; font-family: 'Noto Serif KR', serif; }
    .ok { color: #8ef0b4; font-weight: 800; }
    .err { color: #ff7a8e; font-weight: 800; }
    footer, .log { display: none !important; }
    #hud {
      position: fixed; top: 8px; right: 8px; z-index: 10;
      background: rgba(10,12,16,.78); backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 12px; padding: 6px 10px; display: flex; align-items: center; gap: 10px;
      box-shadow: var(--shadow);
    }
    #timer { font-weight: 800; font-variant-numeric: tabular-nums; letter-spacing: .4px; font-size: 1.2em; }
    #countdown { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); color: #fff; z-index: 20; }
    #countdown span { font-size: 72px; font-weight: 900; text-shadow: 0 2px 12px rgba(0,0,0,.4); }
    @keyframes shake { 0%{transform: translateX(0);} 25%{transform: translateX(-5px);} 50%{transform: translateX(5px);} 75%{transform: translateX(-3px);} 100%{transform: translateX(0);} }
    .shake { animation: shake .28s ease both; }
    @media (max-width: 400px){ :root{ --size: 56px; } #countdown span{ font-size: 56px; } }
    #result{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.5); z-index: 40; padding: 20px; }
    #result .result-card{ background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.015)), var(--card); backdrop-filter: blur(8px) saturate(1.05); border: 1px solid rgba(255,255,255,.10); border-radius: 16px; max-width: 680px; width: 100%; box-shadow: var(--shadow); text-align: left; overflow: hidden; }
    #result .result-card header{ padding: 16px 18px; border-bottom: 1px solid rgba(255,255,255,.08); }
    #result .result-card header h2{ margin: 0; font-size: 1.4rem; font-family: 'Noto Serif KR', serif; color: #ffdfe6; }
    #result .result-body{ padding: 16px 18px; }
    #result .result-summary{ font-size: 2.2rem; font-weight: 900; margin-bottom: 10px; text-align: center; }
    #result .result-pre{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; white-space: pre-wrap; background: rgba(255,255,255,.02); border: 1px solid rgba(255,255,255,.06); border-radius: 12px; padding: 12px; max-height: 45vh; overflow: auto; }
    #result .result-actions{ display: flex; flex-wrap: wrap; gap: 8px; padding: 14px 18px 18px; border-top: 1px solid rgba(255,255,255,.08); }
    #result .result-actions button{ flex: 1 1 auto; }
    #ceremony{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.5); z-index: 35; padding: 20px; }
    #ceremony .tiles{ display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    #ceremony .tile{ width: 44px; height: 44px; border-radius: 10px; display:flex; align-items:center; justify-content:center; font-size: 28px; background: var(--card); border:1px solid rgba(255,255,255,.08); transition: transform .25s ease, background-color .25s ease, color .25s ease; box-shadow: var(--shadow); }
    #ceremony .tile.flip{ transform: scale(1.06); }
    @media (max-width: 400px){ #ceremony .tile{ width: 36px; height: 36px; font-size: 22px; }}
    .ceremony-grid{ display: grid; gap: var(--gap); grid-template-columns: repeat(7, 1fr); margin: 12px auto 0; width: 100%; }
    .ceremony-tile{ width: var(--size); height: var(--size); display:flex; align-items:center; justify-content:center; font-size: calc(var(--size) * 0.66); background: var(--card); border:1px solid rgba(255,255,255,.08); border-radius:14px; transition: transform .25s ease; box-shadow: var(--shadow); }
    .ceremony-tile.flip{ transform: scale(1.06); }
  </style>
</head>
<body>
  <div class="grain" aria-hidden="true"></div>
  <div class="scan" aria-hidden="true"></div>
  <div class="fog" aria-hidden="true"></div>
  <div class="flicker" id="flicker" aria-hidden="true"></div>

  <h1 data-glitch="ìˆ¨ì€ ë¯¸ì†Œê°€ ë‚˜ë¥¼ ë³´ê³  ìˆë‹¤ ğŸ™‚">ìˆ¨ì€ ë¯¸ì†Œê°€ ë‚˜ë¥¼ ë³´ê³  ìˆë‹¤ ğŸ™‚</h1>
  <p class="lead">ê·œì¹™: ê° ìŠ¤í…Œì´ì§€ì—ì„œ <strong>ë‹¨ 1ê°œì˜ ğŸ™‚</strong>ë¥¼ ì°¾ìœ¼ì„¸ìš”. ë¹¨ë¦¬ ì°¾ì§€ ì•Šìœ¼ë©´<strong>(ğŸ˜ )ê³¼ (ğŸ˜)</strong>ì´ ë‹¹ì‹ ì„ ê³„ì† ì«“ì•„ì˜µë‹ˆë‹¤.</p>

  <div id="hud" aria-live="polite" aria-label="ì§„í–‰ HUD">
    <span>ê²½ê³¼</span>
    <span id="timer">00:00.0</span>
  </div>

  <div id="countdown"><span>3</span></div>

  <div id="ceremony" aria-hidden="true">
    <div class="tiles" id="ceremony-tiles"></div>
  </div>

  <div class="toolbar">
    <button id="btn-start">ì‹œì‘</button>
    <button id="btn-restart" disabled>ìƒˆë¡œ ì‹œì‘(ì„ê¸°)</button>
  </div>

  <section id="stages"></section>

  <div class="status" id="status">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

  <div id="result" role="dialog" aria-modal="true" aria-labelledby="result-title" aria-describedby="result-pre" style="display:none;">
    <div class="result-card">
      <header>
        <h2 id="result-title">ìµœì¢… ê¸°ë¡</h2>
      </header>
      <div class="result-body">
        <div class="result-summary" id="result-summary"></div>
        <pre class="result-pre" id="result-pre"></pre>
      </div>
      <div class="result-actions">
        <button id="final-share">ê³µìœ </button>
        <button id="final-restart">ë‹¤ì‹œ ë„ì „</button>
        <button id="final-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="log" id="log" aria-live="polite"></div>
  </footer>

  <script>
    const STAGES = [
      { n: 3, label: '1ë‹¨ê³„ (3Ã—3)' },
      { n: 4, label: '2ë‹¨ê³„ (4Ã—4)' },
      { n: 5, label: '3ë‹¨ê³„ (5Ã—5)' },
      { n: 6, label: '4ë‹¨ê³„ (6Ã—6)' },
      { n: 7, label: '5ë‹¨ê³„ (7Ã—7)' },
    ];

    const EMOJI_ANGRY = 'ğŸ˜ ';
    const EMOJI_NEUTRAL = 'ğŸ˜';
    const EMOJI_SMILE = 'ğŸ™‚';
    const EMOJI_CELEB = 'ğŸ˜Š';

    function mulberry32(a){
      return function(){
        let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296;
      }
    }
    function strToSeed(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }

    const url = new URL(location.href);
    let seedParam = url.searchParams.get('seed');
    if(!seedParam){
      const rand = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*2**32);
      seedParam = rand.toString(36);
      const u = new URL(location.href); u.searchParams.set('seed', seedParam); history.replaceState(null, '', u);
    }
    const SEED = strToSeed(seedParam);
    const rng = mulberry32(SEED);

    function pickAnswerIndex(size){ const total = size*size; return Math.floor(rng()*total); }
    const answers = STAGES.map(s=>pickAnswerIndex(s.n));
    const distractorRatios = STAGES.map(()=> 0.4 + 0.4 * rng());

    const stagesEl = document.getElementById('stages');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const btnStart = document.getElementById('btn-start');
    const btnRestart = document.getElementById('btn-restart');
    const timerEl = document.getElementById('timer');
    const countdownEl = document.getElementById('countdown');
    const countdownNumEl = countdownEl.querySelector('span');
    const resultEl = document.getElementById('result');
    const resultPre = document.getElementById('result-pre');
    const resultSummaryEl = document.getElementById('result-summary');
    const finalShareBtn = document.getElementById('final-share');
    const finalRestartBtn = document.getElementById('final-restart');
    const finalCloseBtn = document.getElementById('final-close');

    let runStart = null;
    const records = [];
    let currentStage = 0;

    let timerId = null;
    function fmtTimeMMSS(ms){
      const total = Math.max(0, ms|0);
      const m = Math.floor(total/60000);
      const s = Math.floor((total%60000)/1000);
      const d = Math.floor((total%1000)/100);
      const pad = n=>String(n).padStart(2,'0');
      return `${pad(m)}:${pad(s)}.${d}`;
    }
    function startTimer(){
      if(timerId) clearInterval(timerId);
      runStart = Date.now();
      timerId = setInterval(()=>{ timerEl.textContent = fmtTimeMMSS(Date.now() - runStart); }, 100);
    }
    function stopTimer(){ if(timerId) clearInterval(timerId); }

    function fmtLocalWithMs(ts){ const d = new Date(ts); const pad = n=>String(n).padStart(2,'0'); const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate()); const h=pad(d.getHours()), mi=pad(d.getMinutes()), s=pad(d.getSeconds()); const ms=String(d.getMilliseconds()).padStart(3,'0'); return `${y}-${m}-${da} ${h}:${mi}:${s}.${ms}`; }

    function writeLog(){
      if(runStart===null){ if(logEl) logEl.textContent = ''; return; }
      const head = `ì‹œë“œ: ${seedParam}\nì‹œì‘: ${fmtLocalWithMs(runStart)} (ISO: ${new Date(runStart).toISOString()})`;
      const lines = records.map(r=>`- ${r.stage} â€” í´ë¦­: ${fmtLocalWithMs(r.clickedAt)} (ISO: ${r.clickedAtIso}), ì†Œìš”: ${r.durationMs}ms, ê·¸ë¦¬ë“œ ${r.grid}ì¹¸`);
      let tail = '';
      if(records.length === STAGES.length){ const end = records[records.length-1].clickedAt; tail = `\nì™„ë£Œ: ${fmtLocalWithMs(end)} (ISO: ${new Date(end).toISOString()})\nì´ ì†Œìš”: ${end - runStart}ms`; }
      if(logEl) logEl.textContent = [head, ...lines, tail].filter(Boolean).join('\n');
    }

    function scaleCurrentStage(){
      const stage = document.querySelector('.stage');
      if(!stage) return;
      const idx = parseInt(stage.dataset.index, 10) || 0;
      const n = STAGES[idx]?.n || 3;
      const cs = getComputedStyle(document.documentElement);
      const gap = parseFloat(cs.getPropertyValue('--gap')) || 8;
      const wrapWidth = stage.clientWidth || stagesEl.clientWidth || (window.innerWidth - 32);
      const size = Math.max(36, Math.floor((wrapWidth - gap * (n - 1)) / n));
      stage.style.setProperty('--size', size + 'px');
    }

    const flicker = document.getElementById('flicker');
    function flash(){ if(!flicker) return; flicker.style.opacity = 1; setTimeout(()=> flicker.style.opacity = 0, 120); }

    function renderStage(idx){
      if(idx < 0 || idx >= STAGES.length) return;
      if(renderStage._busy) return;
      renderStage._busy = true;
      try {
        const {n, label} = STAGES[idx];
        const total = n*n; const answer = answers[idx];
        const ratioAngry = distractorRatios[idx];

        const stageWrap = document.createElement('div'); stageWrap.className = 'stage'; stageWrap.dataset.index = idx;
        const h2 = document.createElement('h2'); h2.textContent = label;
        const grid = document.createElement('div'); grid.className = 'grid'; grid.style.gridTemplateColumns = `repeat(${n}, 1fr)`; grid.style.width = '100%';

        for(let i=0;i<total;i++){
          const cell = document.createElement('button');
          cell.type = 'button'; cell.className = 'cell';
          cell.setAttribute('aria-label', i===answer ? 'ì •ë‹µ' : 'ì˜¤ë‹µ');
          cell.textContent = (i===answer) ? EMOJI_SMILE : ((rng() < ratioAngry) ? EMOJI_ANGRY : EMOJI_NEUTRAL);
          cell.addEventListener('click', ()=>{
            if(i!==answer){
              cell.classList.add('shake'); cell.disabled = true;
              setTimeout(()=>{ cell.classList.remove('shake'); cell.disabled = false; }, 300);
              statusEl.innerHTML = `<span class="err">ì˜¤ë‹µ! ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”â€¦ (ê·¸ë“¤ì´ ê°€ê¹Œì›Œì ¸ìš”)</span>`;
              if (navigator.vibrate) try{ navigator.vibrate(30); }catch(_){}
              flash();
              return;
            }
            const now = Date.now();
            const rec = { stage: label, grid: `${n}Ã—${n}`, clickedAt: now, clickedAtIso: new Date(now).toISOString(), durationMs: now - (records.length ? records[records.length-1].clickedAt : runStart) };
            records.push(rec); writeLog();
            statusEl.innerHTML = `<span class=\"ok\">í†µê³¼!</span> ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.`;
            [...grid.children].forEach(c=>c.disabled = true);

            currentStage++;
            if(currentStage < STAGES.length){
              spawnStage(currentStage);
            } else {
              stopTimer();
              statusEl.innerHTML = `<span class=\"ok\">ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.</span> ê¸°ë¡ì„ í™•ì¸í•˜ê³  ê³µìœ í•´ë³´ì„¸ìš”.`;
              runCeremonyInStageThenAutoShow();
            }
          });
          grid.appendChild(cell);
        }

        const note = document.createElement('div'); note.className = 'note';
        note.textContent = `ì´ ${total}ì¹¸: ğŸ™‚ 1ê°œ, ë‚˜ë¨¸ì§€ ${total-1}ì¹¸ì€ ğŸ˜ /ğŸ˜ ëœë¤`;

        stageWrap.appendChild(h2); stageWrap.appendChild(grid); stageWrap.appendChild(note);

        stagesEl.replaceChildren(stageWrap);
        stageWrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
        scaleCurrentStage();
        history.pushState({emoji:'v1', stage: idx}, '');
      } finally {
        renderStage._busy = false;
      }
    }

    function spawnStage(idx){ renderStage(idx); }

    function runCountdownThenStart(){
      let n = 3;
      countdownNumEl.textContent = String(n);
      countdownEl.style.display = 'flex';
      btnStart.disabled = true; btnRestart.disabled = true;
      const iv = setInterval(()=>{
        n--;
        if(n>0){ countdownNumEl.textContent = String(n); }
        else if(n===0){ countdownNumEl.textContent = 'ì‹œì‘!'; }
        else {
          clearInterval(iv);
          countdownEl.style.display = 'none';
          history.replaceState({emoji:'v1', stage: 'init'}, '');
          history.pushState({emoji:'v1', guard:true}, '');
          window.addEventListener('popstate', ()=>{
            const rand = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*2**32);
            const newSeed = rand.toString(36);
            const u = new URL(location.href); u.searchParams.set('seed', newSeed); location.replace(u);
          }, { once: true });

          statusEl.textContent = '';
          startTimer(); writeLog(); spawnStage(0);
          btnRestart.disabled = false;

          if(!window._emojiScaleHandlerInstalled){
            const onResize = () => scaleCurrentStage();
            window.addEventListener('resize', onResize, { passive: true });
            window.addEventListener('orientationchange', () => setTimeout(onResize, 120), { passive: true });
            window._emojiScaleHandlerInstalled = true;
          }

          setTimeout(runSelfTests, 350);
        }
      }, 1000);
    }

    btnStart.addEventListener('click', ()=>{
      if(runStart!==null) return;
      runCountdownThenStart();
    });

    btnRestart.addEventListener('click', ()=>{
      const rand = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*2**32);
      const newSeed = rand.toString(36);
      const u = new URL(location.href); u.searchParams.set('seed', newSeed); location.href = u.toString();
    });

    function runSelfTests(){
      try {
        console.assert(Array.isArray(STAGES) && STAGES.length === 5, 'STAGES ê¸¸ì´=5');
        const stage = document.querySelector('.stage');
        console.assert(!!stage, 'í˜„ì¬ ìŠ¤í…Œì´ì§€ 1ê°œ í‘œì‹œ');
        const grid = document.querySelector('.grid');
        const n = STAGES[currentStage]?.n || 3;
        console.assert(grid && grid.children.length === n*n, 'ê·¸ë¦¬ë“œ ì¹¸ ìˆ˜ n*n');
        const cells = [...grid.children];
        const smiles = cells.filter(c=>c.textContent===EMOJI_SMILE).length;
        const others = cells.filter(c=>c.textContent!==EMOJI_SMILE);
        console.assert(smiles === 1, 'ğŸ™‚ 1ê°œ');
        console.assert(others.every(c=>c.textContent===EMOJI_ANGRY || c.textContent===EMOJI_NEUTRAL), 'ë‚˜ë¨¸ì§€ ğŸ˜ /ğŸ˜');
        const t0 = document.getElementById('timer').textContent;
        setTimeout(()=>{ const t1 = document.getElementById('timer').textContent; console.assert(t0 !== t1, 'íƒ€ì´ë¨¸ ì¦ê°€'); }, 300);
        scaleCurrentStage();
        const sizeNow = getComputedStyle(document.querySelector('.stage')).getPropertyValue('--size');
        console.assert(!!sizeNow, '--size ê°€ ì„¤ì •ë˜ì–´ì•¼ í•¨');
        const footer = document.querySelector('footer');
        console.assert(getComputedStyle(footer).display === 'none', 'footerëŠ” í‘œì‹œë˜ì§€ ì•Šì•„ì•¼ í•¨');
        console.assert(formatSecs(12345) === '12.35', 'formatSecs(12345) â†’ 12.35');
        console.assert(formatSecs(0) === '0.00', 'formatSecs(0) â†’ 0.00');
        console.assert(typeof shareGeneric === 'function', 'shareGeneric í•¨ìˆ˜ ì¡´ì¬');
        console.assert(buildSummaryHtml() === '0.00ì´ˆ', 'ì‹œì‘ ì „ 0.00ì´ˆ');
        console.assert(formatSecs(2500) === '2.50', 'formatSecs(2500) â†’ 2.50');
        console.assert(typeof buildShareUrl === 'function', 'buildShareUrl í•¨ìˆ˜');
        console.assert(!buildShareUrl().includes('seed='), 'ê³µìœ  URLì—ëŠ” seed ì—†ìŒ');
      } catch(e){ console.warn('SelfTests ì‹¤íŒ¨:', e); }
    }

    function formatSecs(totalMs){ return (Math.max(0, totalMs)/1000).toFixed(2); }
    function buildLogText(){
      if(runStart===null) return '';
      const head = `ì‹œë“œ: ${seedParam}\nì‹œì‘: ${fmtLocalWithMs(runStart)} (ISO: ${new Date(runStart).toISOString()})`;
      const lines = records.map(r=>`- ${r.stage} â€” í´ë¦­: ${fmtLocalWithMs(r.clickedAt)} (ISO: ${r.clickedAtIso}), ì†Œìš”: ${r.durationMs}ms, ê·¸ë¦¬ë“œ ${r.grid}ì¹¸`);
      let tail = '';
      if(records.length === STAGES.length){ const end = records[records.length-1].clickedAt; tail = `\nì™„ë£Œ: ${fmtLocalWithMs(end)} (ISO: ${new Date(end).toISOString()})\nì´ ì†Œìš”: ${end - runStart}ms`; }
      return [head, ...lines, tail].filter(Boolean).join('\n');
    }
    function buildSummaryHtml(){
      const totalMs = (records.length ? records[records.length-1].clickedAt - runStart : 0) || 0;
      const secs = formatSecs(totalMs);
      return `${secs}ì´ˆ`;
    }
    function showResult(){
      if(resultSummaryEl) resultSummaryEl.textContent = buildSummaryHtml();
      if(resultPre) resultPre.style.display = 'none';
      if(resultEl){ resultEl.style.display = 'flex'; setTimeout(()=>{ finalShareBtn && finalShareBtn.focus(); }, 40); }
    }
    function buildShareUrl(){
      const u = new URL(location.href);
      u.searchParams.delete('seed');
      return u.toString();
    }
    function shareGeneric(){
      const totalMs = (records.length ? records[records.length-1].clickedAt - runStart : 0) || 0;
      const secs = formatSecs(totalMs);
      const shareUrl = buildShareUrl();
      const payload = { title: 'ìˆ¨ì€ ë¯¸ì†Œ â€” ê²°ê³¼', text: `ìµœì¢… ê¸°ë¡: ${secs}ì´ˆ`, url: shareUrl };
      if (navigator.share) {
        navigator.share(payload).catch(()=>{});
      } else {
        const text = `${payload.title}\n${payload.text}\n${payload.url}`;
        try {
          navigator.clipboard.writeText(text)
            .then(()=> alert('ê³µìœ  ë‚´ìš©ì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”.'))
            .catch(()=> { prompt('ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì„¸ìš”:', text); });
        } catch(e){
          prompt('ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì„¸ìš”:', text);
        }
      }
    }
    if(finalShareBtn){ finalShareBtn.addEventListener('click', shareGeneric); }
    if(finalRestartBtn){ finalRestartBtn.addEventListener('click', ()=> btnRestart.click()); }
    if(finalCloseBtn){
      finalCloseBtn.addEventListener('click', ()=>{ if(resultEl) resultEl.style.display = 'none'; });
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && resultEl && resultEl.style.display==='flex'){ resultEl.style.display='none'; } });
    }

    function buildCeremonyGrid(container){
      const N = 7; const total = N*N;
      const grid = document.createElement('div');
      grid.className = 'ceremony-grid';
      const cs = getComputedStyle(document.documentElement);
      const gap = parseFloat(cs.getPropertyValue('--gap')) || 8;
      const wrapWidth = (container.clientWidth || stagesEl.clientWidth || (window.innerWidth - 32));
      const size = Math.max(32, Math.floor((wrapWidth - gap * (N - 1)) / N));
      grid.style.setProperty('--size', size + 'px');
      const faces = ['ğŸ˜ ','ğŸ˜','ğŸ™‚'];
      for(let i=0;i<total;i++){
        const tile = document.createElement('div');
        tile.className = 'ceremony-tile';
        tile.textContent = faces[Math.floor(Math.random()*faces.length)];
        grid.appendChild(tile);
      }
      container.appendChild(grid);
      [...grid.children].forEach((tile, idx)=>{
        const delay = 50 * idx; // 0.05s ê°„ê²©ìœ¼ë¡œ ë’¤ì§‘ê¸°
        setTimeout(()=>{ tile.classList.add('flip'); tile.textContent = EMOJI_CELEB; }, delay);
      });
      return grid;
    }

    // ë³€ê²½ì : í´ë¦­ ëŒ€ê¸° ì—†ì´ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ + 1ì´ˆ ë’¤ ìë™ íŒì—…
    function runCeremonyInStageThenAutoShow(){
      const stageWrap = document.createElement('div');
      stageWrap.className = 'stage';
      stageWrap.dataset.index = STAGES.length - 1;
      const h2 = document.createElement('h2'); h2.textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤!';
      stageWrap.appendChild(h2);
      stagesEl.replaceChildren(stageWrap);

      const grid = buildCeremonyGrid(stageWrap);

      // ì´ ì†Œìš”ì‹œê°„ = (íƒ€ì¼ë³„ ì§€ì—° ìµœëŒ€ì¹˜) + flip íŠ¸ëœì§€ì…˜(250ms) + 1ì´ˆ ì—¬ìœ 
      const totalTiles = 7 * 7;
      const perDelay = 50;       // ms
      const flipDuration = 250;  // ms (CSS transition)
      const extraDelay = 1000;   // ms (ìš”ì²­ì‚¬í•­: ì• ë‹ˆë©”ì´ì…˜ ëë‚˜ê³  1ì´ˆ ë’¤)
      const totalTime = perDelay * (totalTiles - 1) + flipDuration + extraDelay;

      setTimeout(()=>{
        showResult();
      }, totalTime);

      const onResize = ()=>{
        const cs = getComputedStyle(document.documentElement);
        const gap = parseFloat(cs.getPropertyValue('--gap')) || 8;
        const N = 7;
        const wrapWidth = (stageWrap.clientWidth || stagesEl.clientWidth || (window.innerWidth - 32));
        const size = Math.max(32, Math.floor((wrapWidth - gap * (N - 1)) / N));
        grid.style.setProperty('--size', size + 'px');
      };
      window.addEventListener('resize', onResize, { passive: true });
      window.addEventListener('orientationchange', ()=> setTimeout(onResize, 120), { passive: true });
    }

    (function(){
      try{
        const temp = document.createElement('div');
        temp.style.width = '420px';
        const g = buildCeremonyGrid(temp);
        console.assert(g.querySelectorAll('.ceremony-tile').length === 49, 'ì„¸ë ˆëª¨ë‹ˆ íƒ€ì¼ ìˆ˜ 49');
      }catch(e){ console.warn('Ceremony unit test failed', e); }
    })();

    setInterval(()=>{
      const h1 = document.querySelector('h1');
      h1.style.animation = 'none'; void h1.offsetWidth; h1.style.animation = '';
    }, 8000 + Math.random()*8000);
  </script>
</body>
</html>

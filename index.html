<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì´ëª¨ì§€ ì°¾ê¸° â€” ëª¨ë°”ì¼ ë‹¨ê³„ì§„í–‰ / ì¹´ìš´íŠ¸ë‹¤ìš´ / ì¼ë°˜ ê³µìœ </title>
  <style>
    :root { --gap: 8px; --size: 60px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif; margin: 0; padding: 56px 16px 24px; text-align: center; }
    h1 { margin: 0 0 6px; font-size: 1.6rem; }
    p.lead { margin: 0 0 18px; color: #444; }
    .toolbar { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 12px; }
    button { border: 1px solid #ccc; border-radius: 12px; padding: 10px 14px; background: #fff; cursor: pointer; font-weight: 600; }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    .stage { margin: 18px auto; max-width: 900px; }
    .stage h2 { margin: 8px 0; }
    .grid { display: inline-grid; gap: var(--gap); margin-top: 8px; width: 100%; }
    .cell { width: var(--size); height: var(--size); display: flex; align-items: center; justify-content: center; text-align: center; padding: 0; font-size: calc(var(--size) * 0.66); line-height: 1; border: 1px solid #ddd; border-radius: 14px; user-select: none; transition: transform .06s; touch-action: manipulation; }
    .cell:active { transform: scale(.98); }
    .note { font-size: .9rem; color: #666; margin-top: 6px; }
    .status { margin-top: 14px; font-size: .95rem; color: #333; min-height: 24px; }
    .ok { color: #087443; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }

    /* ê¸°ë¡ ë¡œê·¸ ì „ë©´ ë¹„í‘œì‹œ */
    footer, .log { display: none !important; }

    /* HUD íƒ€ì´ë¨¸ */
    #hud { position: fixed; top: 8px; right: 8px; z-index: 10; background: rgba(255,255,255,.85); backdrop-filter: blur(6px); border: 1px solid #eee; border-radius: 12px; padding: 6px 10px; display: flex; align-items: center; gap: 10px; }
    #timer { font-weight: 800; font-variant-numeric: tabular-nums; letter-spacing: .4px; font-size: 1.2em; }

    /* ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ */
    #countdown { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); color: #fff; z-index: 20; }
    #countdown span { font-size: 72px; font-weight: 900; text-shadow: 0 2px 12px rgba(0,0,0,.4); }

    /* ì˜¤ë‹µ ì‹œ í”ë“¤ë¦¼ íš¨ê³¼ */
    @keyframes shake { 0%{transform: translateX(0);} 25%{transform: translateX(-5px);} 50%{transform: translateX(5px);} 75%{transform: translateX(-3px);} 100%{transform: translateX(0);} }
    .shake { animation: shake .28s ease both; }

    @media (max-width: 400px){ :root{ --size: 56px; } #countdown span{ font-size: 56px; } }

    /* ìµœì¢… ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
    #result{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.5); z-index: 40; padding: 20px; }
    #result .result-card{ background: #fff; border: 1px solid #eee; border-radius: 16px; max-width: 680px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,.15); text-align: left; }
    #result .result-card header{ padding: 16px 18px; border-bottom: 1px solid #f0f0f0; }
    #result .result-card header h2{ margin: 0; font-size: 1.4rem; }
    #result .result-body{ padding: 16px 18px; }
    #result .result-summary{ font-size: 2.2rem; font-weight: 900; margin-bottom: 10px; text-align: center; }
    #result .result-pre{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 12px; max-height: 45vh; overflow: auto; }
    #result .result-actions{ display: flex; flex-wrap: wrap; gap: 8px; padding: 14px 18px 18px; border-top: 1px solid #f0f0f0; }
    #result .result-actions button{ flex: 1 1 auto; }
      /* ì„¸ë ˆëª¨ë‹ˆ ì˜¤ë²„ë ˆì´ */
    #ceremony{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.5); z-index: 35; padding: 20px; }
    #ceremony .tiles{ display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    #ceremony .tile{ width: 44px; height: 44px; border-radius: 10px; display:flex; align-items:center; justify-content:center; font-size: 28px; background:#fff; border:1px solid #eee; transition: transform .25s ease, background-color .25s ease, color .25s ease; }
    #ceremony .tile.flip{ transform: scale(1.06); }
    @media (max-width: 400px){ #ceremony .tile{ width: 36px; height: 36px; font-size: 22px; }}
      /* ì„¸ë ˆëª¨ë‹ˆ: ìŠ¤í…Œì´ì§€ ëŒ€ì²´í˜• */
    .ceremony-grid{ display: grid; gap: var(--gap); grid-template-columns: repeat(7, 1fr); margin: 12px auto 0; width: 100%; }
    .ceremony-tile{ width: var(--size); height: var(--size); display:flex; align-items:center; justify-content:center; font-size: calc(var(--size) * 0.66); background:#fff; border:1px solid #eee; border-radius:14px; transition: transform .25s ease; }
    .ceremony-tile.flip{ transform: scale(1.06); }

  </style>
</head>
<body>
  <h1>ì›ƒëŠ” ì´ëª¨ì§€ í•œ ì¹¸ë§Œ ì°¾ê¸° ğŸ™‚</h1>
  <p class="lead">ê·œì¹™: ê° ìŠ¤í…Œì´ì§€ ê·¸ë¦¬ë“œì—ì„œ <strong>ë‹¨ 1ì¹¸ì˜ ğŸ™‚</strong>ë¥¼ ì°¾ìœ¼ì„¸ìš”. ë‚˜ë¨¸ì§€ëŠ” <strong>ë…¸ë€ í™”ë‚¨(ğŸ˜ )ê³¼ ë¬´í‘œì •(ğŸ˜)</strong>ì´ ë¬´ì‘ìœ„ ë¹„ìœ¨ë¡œ ì„ì—¬ ìˆìŠµë‹ˆë‹¤.</p>

  <div id="hud" aria-live="polite" aria-label="ì§„í–‰ HUD">
    <span>ê²½ê³¼</span>
    <span id="timer">00:00.0</span>
  </div>

  <div id="countdown"><span>3</span></div>

  <div id="ceremony" aria-hidden="true">
    <div class="tiles" id="ceremony-tiles"></div>
  </div>

  <div class="toolbar">
    <button id="btn-start">ì‹œì‘</button>
    <button id="btn-restart" disabled>ìƒˆë¡œ ì‹œì‘(ì„ê¸°)</button>
    <!-- ê²°ê³¼ ë§í¬ ë³µì‚¬ ë²„íŠ¼ ì œê±°ë¨ -->
  </div>

  <section id="stages"></section>

  <div class="status" id="status">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

  <div id="result" role="dialog" aria-modal="true" aria-labelledby="result-title" aria-describedby="result-pre" style="display:none;">
    <div class="result-card">
      <header>
        <h2 id="result-title">ìµœì¢… ê¸°ë¡</h2>
      </header>
      <div class="result-body">
        <div class="result-summary" id="result-summary"></div>
        <pre class="result-pre" id="result-pre"></pre>
      </div>
      <div class="result-actions">
        <button id="final-share">ê³µìœ </button>
        <!-- ê²°ê³¼ ë§í¬ ë³µì‚¬ ë²„íŠ¼ ì œê±°ë¨ -->
        <button id="final-restart">ë‹¤ì‹œ ë„ì „</button>
        <button id="final-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="log" id="log" aria-live="polite"></div>
  </footer>

  <script>
    // ===== ì„¤ì • =====
    const STAGES = [
      { n: 3, label: '1ë‹¨ê³„ (3Ã—3)' },
      { n: 4, label: '2ë‹¨ê³„ (4Ã—4)' },
      { n: 5, label: '3ë‹¨ê³„ (5Ã—5)' },
      { n: 6, label: '4ë‹¨ê³„ (6Ã—6)' },
      { n: 7, label: '5ë‹¨ê³„ (7Ã—7)' },
    ];

    const EMOJI_ANGRY = 'ğŸ˜ '; // ë…¸ë€ìƒ‰ í™”ë‚¨
    const EMOJI_NEUTRAL = 'ğŸ˜';
    const EMOJI_SMILE = 'ğŸ™‚'; // ë¹¨ê°„/ë¶„í™ ë³¼í„°ì¹˜ ì—†ëŠ” ë¯¸ì†Œ
    const EMOJI_CELEB = 'ğŸ˜Š'; // ì„¸ë ˆëª¨ë‹ˆ íƒ€ì¼ ì´ëª¨ì§€

    // ===== ì‹œë“œ ë‚œìˆ˜ (ì¬í˜„ì„± + ê³µìœ  ë§í¬) =====
    function mulberry32(a){
      return function(){
        let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296;
      }
    }
    function strToSeed(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }

    const url = new URL(location.href);
    let seedParam = url.searchParams.get('seed');
    if(!seedParam){
      const rand = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*2**32);
      seedParam = rand.toString(36);
      const u = new URL(location.href); u.searchParams.set('seed', seedParam); history.replaceState(null, '', u);
    }
    const SEED = strToSeed(seedParam);
    const rng = mulberry32(SEED);

    function pickAnswerIndex(size){ const total = size*size; return Math.floor(rng()*total); }
    const answers = STAGES.map(s=>pickAnswerIndex(s.n));

    // ê° ìŠ¤í…Œì´ì§€ë³„ ë°©í•´ ì´ëª¨ì§€ ë¹„ìœ¨(ğŸ˜  ë¹„ì¤‘) â€” 0.4 ~ 0.8 ë²”ìœ„ ëœë¤
    const distractorRatios = STAGES.map(()=> 0.4 + 0.4 * rng());

    // ===== DOM ì—˜ë¦¬ë¨¼íŠ¸ =====
    const stagesEl = document.getElementById('stages');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const btnStart = document.getElementById('btn-start');
    const btnRestart = document.getElementById('btn-restart');
    const timerEl = document.getElementById('timer');
    const countdownEl = document.getElementById('countdown');
    const countdownNumEl = countdownEl.querySelector('span');

    // ì„¸ë ˆëª¨ë‹ˆ ìš”ì†Œ
    const ceremonyEl = document.getElementById('ceremony');
    const ceremonyTilesEl = document.getElementById('ceremony-tiles');

    // ìµœì¢… ê²°ê³¼ ì˜¤ë²„ë ˆì´ ìš”ì†Œ
    const resultEl = document.getElementById('result');
    const resultPre = document.getElementById('result-pre');
    const resultSummaryEl = document.getElementById('result-summary');
    const finalShareBtn = document.getElementById('final-share');
    const finalRestartBtn = document.getElementById('final-restart');
    const finalCloseBtn = document.getElementById('final-close');

    // ê¸°ë¡ êµ¬ì¡°
    let runStart = null; // ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥¸ ìˆœê°„ìœ¼ë¡œ ì„¤ì •
    const records = []; // {stage, grid, clickedAt, clickedAtIso, durationMs}
    let currentStage = 0; // 0ë¶€í„° ìˆœì°¨ ì§„í–‰

    // ===== íƒ€ì´ë¨¸ =====
    let timerId = null;
    function fmtTimeMMSS(ms){
      const total = Math.max(0, ms|0);
      const m = Math.floor(total/60000);
      const s = Math.floor((total%60000)/1000);
      const d = Math.floor((total%1000)/100); // 0.1ì´ˆ ë‹¨ìœ„
      const pad = n=>String(n).padStart(2,'0');
      return `${pad(m)}:${pad(s)}.${d}`;
    }
    function startTimer(){
      if(timerId) clearInterval(timerId);
      runStart = Date.now();
      timerId = setInterval(()=>{ timerEl.textContent = fmtTimeMMSS(Date.now() - runStart); }, 100);
    }
    function stopTimer(){ if(timerId) clearInterval(timerId); }

    function fmtLocalWithMs(ts){ const d = new Date(ts); const pad = n=>String(n).padStart(2,'0'); const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate()); const h=pad(d.getHours()), mi=pad(d.getMinutes()), s=pad(d.getSeconds()); const ms=String(d.getMilliseconds()).padStart(3,'0'); return `${y}-${m}-${da} ${h}:${mi}:${s}.${ms}`; }

    function writeLog(){
      if(runStart===null){ if(logEl) logEl.textContent = ''; return; }
      const head = `ì‹œë“œ: ${seedParam}\nì‹œì‘: ${fmtLocalWithMs(runStart)} (ISO: ${new Date(runStart).toISOString()})`;
      const lines = records.map(r=>`- ${r.stage} â€” í´ë¦­: ${fmtLocalWithMs(r.clickedAt)} (ISO: ${r.clickedAtIso}), ì†Œìš”: ${r.durationMs}ms, ê·¸ë¦¬ë“œ ${r.grid}ì¹¸`);
      let tail = '';
      if(records.length === STAGES.length){ const end = records[records.length-1].clickedAt; tail = `\nì™„ë£Œ: ${fmtLocalWithMs(end)} (ISO: ${new Date(end).toISOString()})\nì´ ì†Œìš”: ${end - runStart}ms`; }
      if(logEl) logEl.textContent = [head, ...lines, tail].filter(Boolean).join('\n');
    }

    // ===== ë°˜ì‘í˜• ìŠ¤ì¼€ì¼ë§: í˜„ì¬ ìŠ¤í…Œì´ì§€ ê·¸ë¦¬ë“œë¥¼ í™”ë©´í­ì— ë§ì¶¤ =====
    function scaleCurrentStage(){
      const stage = document.querySelector('.stage');
      if(!stage) return;
      const idx = parseInt(stage.dataset.index, 10) || 0;
      const n = STAGES[idx]?.n || 3;
      const cs = getComputedStyle(document.documentElement);
      const gap = parseFloat(cs.getPropertyValue('--gap')) || 8;
      const wrapWidth = stage.clientWidth || stagesEl.clientWidth || (window.innerWidth - 32);
      const size = Math.max(36, Math.floor((wrapWidth - gap * (n - 1)) / n));
      stage.style.setProperty('--size', size + 'px');
    }

    // ===== ìŠ¤í…Œì´ì§€ ë Œë” =====
    function renderStage(idx){
      if(idx < 0 || idx >= STAGES.length) return;
      if(renderStage._busy) return; // ì¬ì§„ì… ë°©ì§€
      renderStage._busy = true;
      try {
        const {n, label} = STAGES[idx];
        const total = n*n; const answer = answers[idx];
        const ratioAngry = distractorRatios[idx];

        const stageWrap = document.createElement('div'); stageWrap.className = 'stage'; stageWrap.dataset.index = idx;
        const h2 = document.createElement('h2'); h2.textContent = label;
        const grid = document.createElement('div'); grid.className = 'grid'; grid.style.gridTemplateColumns = `repeat(${n}, 1fr)`; grid.style.width = '100%';

        for(let i=0;i<total;i++){
          const cell = document.createElement('button');
          cell.type = 'button'; cell.className = 'cell';
          cell.setAttribute('aria-label', i===answer ? 'ì •ë‹µ' : 'ì˜¤ë‹µ');
          if(i===answer){
            cell.textContent = EMOJI_SMILE;
          } else {
            cell.textContent = (rng() < ratioAngry) ? EMOJI_ANGRY : EMOJI_NEUTRAL;
          }
          cell.addEventListener('click', ()=>{
            if(i!==answer){
              cell.classList.add('shake'); cell.disabled = true;
              setTimeout(()=>{ cell.classList.remove('shake'); cell.disabled = false; }, 300);
              statusEl.innerHTML = `<span class="err">ì˜¤ë‹µ! ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</span>`;
              return;
            }
            // ì •ë‹µ ì²˜ë¦¬
            const now = Date.now();
            const rec = { stage: label, grid: `${n}Ã—${n}`, clickedAt: now, clickedAtIso: new Date(now).toISOString(), durationMs: now - (records.length ? records[records.length-1].clickedAt : runStart) };
            records.push(rec); writeLog();
            statusEl.innerHTML = `<span class=\"ok\">í†µê³¼!</span> ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.`;
            [...grid.children].forEach(c=>c.disabled = true);

            currentStage++;
            if(currentStage < STAGES.length){
              spawnStage(currentStage);
            } else {
              stopTimer();
              statusEl.innerHTML = `<span class=\"ok\">ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.</span> ê¸°ë¡ì„ í™•ì¸í•˜ê³  ê³µìœ í•´ë³´ì„¸ìš”.`;
              runCeremonyInStageThenAwaitClick();
            }
          });
          grid.appendChild(cell);
        }

        const note = document.createElement('div'); note.className = 'note';
        note.textContent = `ì´ ${total}ì¹¸: ${EMOJI_SMILE} 1ê°œ, ë‚˜ë¨¸ì§€ ${total-1}ì¹¸ì€ ${EMOJI_ANGRY}/${EMOJI_NEUTRAL} ëœë¤`;

        stageWrap.appendChild(h2); stageWrap.appendChild(grid); stageWrap.appendChild(note);

        stagesEl.replaceChildren(stageWrap);
        stageWrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
        scaleCurrentStage();
        history.pushState({emoji:'v1', stage: idx}, '');
      } finally {
        renderStage._busy = false;
      }
    }

    function spawnStage(idx){ renderStage(idx); }

    // ===== ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ ì‹œì‘ =====
    function runCountdownThenStart(){
      let n = 3;
      countdownNumEl.textContent = String(n);
      countdownEl.style.display = 'flex';
      btnStart.disabled = true; btnRestart.disabled = true;
      const iv = setInterval(()=>{
        n--;
        if(n>0){ countdownNumEl.textContent = String(n); }
        else if(n===0){ countdownNumEl.textContent = 'ì‹œì‘!'; }
        else {
          clearInterval(iv);
          countdownEl.style.display = 'none';
          history.replaceState({emoji:'v1', stage: 'init'}, '');
          history.pushState({emoji:'v1', guard:true}, '');
          window.addEventListener('popstate', ()=>{
            const rand = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*2**32);
            const newSeed = rand.toString(36);
            const u = new URL(location.href); u.searchParams.set('seed', newSeed); location.replace(u);
          }, { once: true });

          statusEl.textContent = '';
          startTimer(); writeLog(); spawnStage(0);
          btnRestart.disabled = false; // ì‹œì‘ í›„ ì¬ì‹œì‘ ê°€ëŠ¥

          if(!window._emojiScaleHandlerInstalled){
            const onResize = () => scaleCurrentStage();
            window.addEventListener('resize', onResize, { passive: true });
            window.addEventListener('orientationchange', () => setTimeout(onResize, 120), { passive: true });
            window._emojiScaleHandlerInstalled = true;
          }

          setTimeout(runSelfTests, 350);
        }
      }, 1000);
    }

    // ===== ì‹œì‘/ì¬ì‹œì‘ =====
    btnStart.addEventListener('click', ()=>{
      if(runStart!==null) return; // ì´ë¯¸ ì‹œì‘ë¨
      runCountdownThenStart();
    });

    btnRestart.addEventListener('click', ()=>{
      const rand = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint32Array(1))[0] : Math.floor(Math.random()*2**32);
      const newSeed = rand.toString(36);
      const u = new URL(location.href); u.searchParams.set('seed', newSeed); location.href = u.toString();
    });

    // ===== ì½˜ì†”ìš© ê°„ë‹¨ + ì¶”ê°€ í…ŒìŠ¤íŠ¸ =====
    function runSelfTests(){
      try {
        console.assert(Array.isArray(STAGES) && STAGES.length === 5, 'STAGES ê¸¸ì´=5');
        const stage = document.querySelector('.stage');
        console.assert(!!stage, 'í˜„ì¬ ìŠ¤í…Œì´ì§€ 1ê°œ í‘œì‹œ');
        const grid = document.querySelector('.grid');
        const n = STAGES[currentStage]?.n || 3;
        console.assert(grid && grid.children.length === n*n, 'ê·¸ë¦¬ë“œ ì¹¸ ìˆ˜ n*n');
        const cells = [...grid.children];
        const smiles = cells.filter(c=>c.textContent===EMOJI_SMILE).length;
        const others = cells.filter(c=>c.textContent!==EMOJI_SMILE);
        console.assert(smiles === 1, 'ğŸ™‚ 1ê°œ');
        console.assert(others.every(c=>c.textContent===EMOJI_ANGRY || c.textContent===EMOJI_NEUTRAL), 'ë‚˜ë¨¸ì§€ ğŸ˜ /ğŸ˜');
        const t0 = document.getElementById('timer').textContent;
        setTimeout(()=>{ const t1 = document.getElementById('timer').textContent; console.assert(t0 !== t1, 'íƒ€ì´ë¨¸ ì¦ê°€'); }, 300);

        // ê¸°ì¡´ ìŠ¤ì¼€ì¼/ìˆ¨ê¹€/í¬ë§· í…ŒìŠ¤íŠ¸
        scaleCurrentStage();
        const sizeNow = getComputedStyle(document.querySelector('.stage')).getPropertyValue('--size');
        console.assert(!!sizeNow, '--size ê°€ ì„¤ì •ë˜ì–´ì•¼ í•¨');
        const footer = document.querySelector('footer');
        console.assert(getComputedStyle(footer).display === 'none', 'footerëŠ” í‘œì‹œë˜ì§€ ì•Šì•„ì•¼ í•¨');
        console.assert(formatSecs(12345) === '12.35', 'formatSecs(12345) â†’ 12.35');
        console.assert(formatSecs(0) === '0.00', 'formatSecs(0) â†’ 0.00');

        // ì¶”ê°€ í…ŒìŠ¤íŠ¸ (ì‹ ê·œ)
        console.assert(typeof shareGeneric === 'function', 'shareGeneric í•¨ìˆ˜ê°€ ì¡´ì¬í•´ì•¼ í•¨');
        console.assert(buildSummaryHtml() === '0.00ì´ˆ', 'ì‹œì‘ ì „ì—ëŠ” 0.00ì´ˆê°€ í‘œì‹œë˜ì–´ì•¼ í•¨');
        console.assert(formatSecs(2500) === '2.50', 'formatSecs(2500) â†’ 2.50');
      } catch(e){ console.warn('SelfTests ì‹¤íŒ¨:', e); }
    }

    // ===== ìµœì¢… ê²°ê³¼ ìƒì„± ë° í‘œì‹œ =====
    function formatSecs(totalMs){ return (Math.max(0, totalMs)/1000).toFixed(2); }

    function buildLogText(){
      if(runStart===null) return '';
      const head = `ì‹œë“œ: ${seedParam}\nì‹œì‘: ${fmtLocalWithMs(runStart)} (ISO: ${new Date(runStart).toISOString()})`;
      const lines = records.map(r=>`- ${r.stage} â€” í´ë¦­: ${fmtLocalWithMs(r.clickedAt)} (ISO: ${r.clickedAtIso}), ì†Œìš”: ${r.durationMs}ms, ê·¸ë¦¬ë“œ ${r.grid}ì¹¸`);
      let tail = '';
      if(records.length === STAGES.length){ const end = records[records.length-1].clickedAt; tail = `\nì™„ë£Œ: ${fmtLocalWithMs(end)} (ISO: ${new Date(end).toISOString()})\nì´ ì†Œìš”: ${end - runStart}ms`; }
      return [head, ...lines, tail].filter(Boolean).join('\n');
    }

    function buildSummaryHtml(){
      const totalMs = (records.length ? records[records.length-1].clickedAt - runStart : 0) || 0;
      const secs = formatSecs(totalMs);
      return `${secs}ì´ˆ`;
    }

    function showResult(){
      if(resultSummaryEl) resultSummaryEl.textContent = buildSummaryHtml();
      if(resultPre) resultPre.style.display = 'none';
      if(resultEl){ resultEl.style.display = 'flex'; setTimeout(()=>{ finalShareBtn && finalShareBtn.focus(); }, 40); }
    }

    // ===== ì¼ë°˜ ê³µìœ  (Web Share API + í´ë¦½ë³´ë“œ í´ë°±) =====
    function shareGeneric(){
      const totalMs = (records.length ? records[records.length-1].clickedAt - runStart : 0) || 0;
      const secs = formatSecs(totalMs);
      const shareUrl = location.href;
      const payload = { title: 'ì´ëª¨ì§€ ì°¾ê¸° ê²°ê³¼', text: `ìµœì¢… ê¸°ë¡: ${secs}ì´ˆ`, url: shareUrl };

      if (navigator.share) {
        navigator.share(payload).catch(()=>{ /* ì‚¬ìš©ìê°€ ì·¨ì†Œ */ });
      } else {
        const text = `${payload.title}\n${payload.text}\n${payload.url}`;
        try {
          navigator.clipboard.writeText(text)
            .then(()=> alert('ê³µìœ  ë‚´ìš©ì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”.'))
            .catch(()=> { prompt('ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì„¸ìš”:', text); });
        } catch(e){
          prompt('ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì„¸ìš”:', text);
        }
      }
    }

    // ë²„íŠ¼ ë™ì‘ ë°”ì¸ë”© (ì˜¤ë²„ë ˆì´ ê³µìœ )
    if(finalShareBtn){
      finalShareBtn.addEventListener('click', shareGeneric);
    }

    if(finalRestartBtn){
      finalRestartBtn.addEventListener('click', ()=> btnRestart.click());
    }

    if(finalCloseBtn){
      finalCloseBtn.addEventListener('click', ()=>{ if(resultEl) resultEl.style.display = 'none'; });
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && resultEl && resultEl.style.display==='flex'){ resultEl.style.display='none'; } });
    }

    // ===== ì„¸ë ˆëª¨ë‹ˆ ìœ í‹¸: ì»¨í…Œì´ë„ˆì— 7x7 ìƒì„± ë° ì• ë‹ˆë©”ì´ì…˜ =====
    function buildCeremonyGrid(container){
      const N = 7; const total = N*N;
      const grid = document.createElement('div');
      grid.className = 'ceremony-grid';
      const cs = getComputedStyle(document.documentElement);
      const gap = parseFloat(cs.getPropertyValue('--gap')) || 8;
      const wrapWidth = (container.clientWidth || stagesEl.clientWidth || (window.innerWidth - 32));
      const size = Math.max(32, Math.floor((wrapWidth - gap * (N - 1)) / N));
      grid.style.setProperty('--size', size + 'px');

      const faces = ['ğŸ˜ ','ğŸ˜','ğŸ™‚'];
      for(let i=0;i<total;i++){
        const tile = document.createElement('div');
        tile.className = 'ceremony-tile';
        tile.textContent = faces[Math.floor(Math.random()*faces.length)];
        grid.appendChild(tile);
      }
      container.appendChild(grid);

      [...grid.children].forEach((tile, idx)=>{
        const delay = 20 * idx; // 0.02s ê°„ê²©
        setTimeout(()=>{ tile.classList.add('flip'); tile.textContent = EMOJI_CELEB; }, delay);
      });
      return grid;
    }

    function runCeremonyInStageThenAwaitClick(){
      const stageWrap = document.createElement('div');
      stageWrap.className = 'stage';
      stageWrap.dataset.index = STAGES.length - 1;
      const h2 = document.createElement('h2'); h2.textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤!';
      stageWrap.appendChild(h2);
      stagesEl.replaceChildren(stageWrap);

      const grid = buildCeremonyGrid(stageWrap);

      const onFirstClick = ()=>{
        window.removeEventListener('click', onFirstClick, true);
        showResult();
      };
      window.addEventListener('click', onFirstClick, true);

      const onResize = ()=>{
        const cs = getComputedStyle(document.documentElement);
        const gap = parseFloat(cs.getPropertyValue('--gap')) || 8;
        const N = 7;
        const wrapWidth = (stageWrap.clientWidth || stagesEl.clientWidth || (window.innerWidth - 32));
        const size = Math.max(32, Math.floor((wrapWidth - gap * (N - 1)) / N));
        grid.style.setProperty('--size', size + 'px');
      };
      window.addEventListener('resize', onResize, { passive: true });
      window.addEventListener('orientationchange', ()=> setTimeout(onResize, 120), { passive: true });
    }

    // ===== í…ŒìŠ¤íŠ¸: ì„¸ë ˆëª¨ë‹ˆ ë¹Œë” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ =====
    (function(){
      try{
        const temp = document.createElement('div');
        temp.style.width = '420px';
        const g = buildCeremonyGrid(temp);
        console.assert(g.querySelectorAll('.ceremony-tile').length === 49, 'ì„¸ë ˆëª¨ë‹ˆ íƒ€ì¼ ìˆ˜ 49');
      }catch(e){ console.warn('Ceremony unit test failed', e); }
    })();

  </script>
</body>
</html>
